gateway port = 3000
auth port = 3001
event = 3002 

----------------- 실행
docker-compose up -d --build
------------------------
포스트맨 설치
함수형은 카멜케이스
URL엔드포인트는 kebab



과제개요의 authserver에서
"유저 정보 관리" 부분이


기능 상세에 적인 "유저 등록" 만 있으면 되는지?


"유저의 정보를 관리한다." 라는 개념으로 들어가서
유저 등록, 조회, 수정, 삭제가 다 가능해야하는지? 명확하지 않아
일단 다 만들었습니다 
----------------------
PM 요청사항
문제유출가능성으로 제외

KeyPoint
"보상을 운영자가 검토 & 자동으로 줌"
----------------

아키텍쳐 정리
1. 로그인과 토큰발급 = Client -> GateWay -> Auth
2. 인증, 권한 검사 GateWay (AuthGaurd/RolesGuard)
3. API요청 : GateWay -> Auth/Event 

-------------------
DB 설계

테이블설계

U(유저테이블)
U_ID        // 유저 고유 ID
U_LoginID   // 로그인 ID
U_LoginPW   // 비밀번호
U_Name      // 이름
U_NickNm    // 닉네임
U_Role      // 역할
U_CreDe     // 생성일
U_IsDel     // 탈퇴여부
U_DelDe     // 탈퇴일


RW(보상테이블)
RW_ID       // 보상 고유 ID
RW_Nm       // 보상명
RW_Qty      // 보상 개수
RW_U_ID     // 등록한 유저 고유ID
RW_De       // 등록일
RW_E_ID     // 이벤트 ID

E(이벤트테이블)
E_ID        // 이벤트 고유 ID
E_Nm        // 이벤트명
E_SrtDe     // 이벤트시작일
E_EndDe     // 이벤트종료일
E_Sts       // 이벤트상태
E_U_ID      // 이벤트 등록자
E_InDe      // 이벤트 등록일

R(역할테이블)
R_ID        // 역할 고유 ID
R_Nm        // 역할이름
R_Per       // 역할별 권한설정

UQ(통합테이블)
UQ_ID       // 통합고유ID
UQ_U_ID     // 유저고유ID
UQ_E_ID     // 이벤트고유ID
UQ_RW_ID    // 보상 고유 ID
UQ_Qty      // 보상 수량
UQ_Sts      // 지급 여부(대기,획득,사용)
UQ_De       // 지급 

CQ(퀴즈테이블)
CQ_ID       // 퀴즈 고유ID
CQ_E_ID     // 이벤트 고유ID
CQ_Que      // 퀴즈 문제
CQ_Hint     // 퀴즈 힌트
CQ_Ans      // 퀴즈 답
CQ_U_ID     // 퀴즈 등록자(관리자만가능)


RT(보상 대기 테이블)
WR_ID       // 보상 대기 ID
WR_E_ID     // 이벤트 고유 ID
WR_RW_ID    // 보상 아이템 고유 ID
WR_U_ID     // 유저 고유 ID
WR_Qty      // 보상 검증용 수량
WR_De       // 등록일
WR_Sts      // 보상 대기/승인 

공통적으로 테이블명_ID
mssql기준 사용자 정의 함수로 만들고, 모든 데이터 관리는 프로시져로 작성해야합니다.

예시) 데이터 삽입시, U_00000001 , U_0000002 이렇게 끝 숫자가 자동으로 증가되어 insert되게 됩니다

---------------------------------------------------------------------------
이벤트 정리


조건
1. 운영자 또는 관리자가 이벤트를 생성할수있어야하며
2. 보상 정보를 추가할 수 있어야한다.
3. 유저는 특정 이벤트에 대해 보상을 요청해야한다.

룰렛이벤트
초성퀴즈 맞출시 3장 자동지급 (사용자가 입력한 값이 답이 맞는지 검증 맞으면, 자동지급)
룰렛권 10장, 20장,30장 획득하면, 특별보상 추가 지급 신청(운영자가 검토필요, 중복지급X)

룰렛돌리면 랜덤하게 보상획득




이벤트 등록:
이벤트이름과, 시작일, 종료일, 이벤트상태,유저 고유ID를 param으로하여 프로시저를 이용한다면
E테이블의 레코드가 기록되고, 기록된 레코드의 E_ID가 Output으로 나와 조건테이블의 레코드도 같이 기록됩니다.

이벤트 조회 : 
이벤트 조회시 , 여러종류의 param값으로 이벤트별, 등록자별, 기간별로 조회가 가능하며, 
UQ테이블 활용시(유저별,보상별) 등으로 조회도 가능합니다.

UQ 테이블이란?
모든 유저의 보상 지급 이력 테이블 입니다.
보상을 요청 할 시 
해당 유저의 U_ID
이벤트 테이블의 E_ID
보상테이블의 RW_ID
를 param값으로 받아 데이터가 insert되게 됩니다.

UQ_Qty(보상수량)은 특정 조건에만 RW_Qty와 매핑됩니다.


예를들어 홍길동(U_0001) 퀴즈를 맞춰(E_0001), 총 티켓(RW_0001)의 보상을 3개 획득했다면


----------------------------------------------

1. 퀴즈맞춰야함
퀴즈맞추는 로직
문제 

E_ID      E_Nm      E_SrtDe         E_EndDe         E_Sts     E_U_ID        E_InDe    
E_0001    초성퀴즈   2025-05-18     2025-05-19      진행중      E_0005       2025-05-13



CQ_ID       CQ_Que      CQ_E_ID     CQ_Ans          CQ_Hint     CQ_U_ID 
CQ_0001     ㅇㅂㅇㅈ     E_0001     이블윙즈        법사 무기       U_0005(관리자)
CQ_0002     ㅇㅊㄱ       E_0001      용천권          도적무기       U_0005(관리자)
CQ_0003     ㅈㅋㅇㅌㄱ    E_0001     자쿰의투구         모자        U_0005(관리자)


SELECT TOP 1
        CQ_ID
    ,   CQ_Que
    ,   CQ_E_ID
    ,   CQ_Ans
    ,   CQ_Hint
FROM 
        CQ
INNER JOIN E
ON
        CQ_E_ID = E_ID
WHERE
        E_ID = 'E_0001'
AND
        E_Sts = '진행중'
ORDER BY NEWID();

랜덤으로 데이터를 하나 가져오고, 
사용자가 입력한 정답이, CQ_Ans와 같으면 티켓 3장 발급





퀴즈이벤트(E_0001) Record를 따라 UQ테이블에 기록됩니다.

간략하게 데이터의 시각화를 한다면,

UQ_ID      UQ_U_ID    UQ_E_ID   UQ_RW_ID     UQ_Qty   UQ_Sts    UQ_De    
UQ_0001    U_0001     E_0001    RW_0001         3       획득    2024-01-23

이런 형태가 될것이고, 

룰렛(E_0003)을 2번 돌리게 된다면

UQ_ID      UQ_U_ID    UQ_E_ID   UQ_RW_ID     UQ_Qty     UQ_Sts    UQ_De    
UQ_0001    U_0001     E_0001    RW_0001         3        획득    2024-01-23
UQ_0002    U_0001     E_0003    RW_0001         -1       사용    2024-01-23
UQ_0003    U_0001     E_0003    RW_0001         -1       사용    2024-01-23


이런 형태로 데이터가 기록됩니다.

룰렛의 남은 갯수를 사용자에게 보여줄 때에는, 
SELECT 
        UQ_U_ID
    ,   UQ_RW_ID
    ,   SUM(UQ_Qty)
FROM 
        UQ
WHERE 
        UQ_U_ID = 'U_0001' //유저 고유 ID
AND 
        UQ_RW_ID = 'RW_0001' // 티켓
GROUP BY 
        UQ_U_ID, UQ_RW_ID


만약 룰렛을 10번을 돌렸을때 특별 보상을 신청할수있다면,

SELECT 
        UQ_U_ID
    ,   UQ_E_ID
    ,   UQ_RW_ID
    ,   SUM(UQ_Qty) * -1
FROM    UQ
WHERE 
        UQ_U_ID = 'U_0001'      //유저 고유ID param
AND 
        UQ_E_ID = 'E_0003'      // 룰렛이벤트
AND 
        UQ_RW_ID = 'RW_0001'    // 티켓
GROUP BY 
        UQ_U_ID, UQ_RW_ID


받아온 데이터의 UQ_Qty >= 10 조건만 충족한다면, 특별 보상을 신청할 수 있습니다.

특별 보상은 중복을 막아야하기에, 
UQ테이블에, 해당 User의 특별보상(RW_ID)의 데이터가 존재할 경우, Disable진행



운영자가 검증시 예시)

// pm의 요구사항 중, 운영자가 "검토하거나" 자동으로 지급 

신청 보상이 익성비 3개 이고, 보상버튼을 눌렀을 때 현재 돌린 횟수를 param으로 받아 WR_Qty에 값을 입력하게됩니다. 
예시로 룰렛을 22번돌린사람이 10번보상과 20번보상을 신청했다면
보상 대기테이블인 RT테이블에 WR_Sts에 대기 라는 글자와 함께 각 보상명이 저장됩니다.

-보상내용-
RW_ID    RW_Nm    RW_Qty    RW_U_ID(보상등록자)        RW_TiC           RW_De         
RW_0010  익성비    3         U_0005(관리자)                10       2023-01-01                 // 10번눌렀을때 보상
RW_0011  용천권    1         U_0005(관리자)                20       2023-01-01                 // 20번눌렀을때 보상


SELECT 
        WR_ID   
    ,   WR_E_ID 
    ,   WR_RW_ID
    ,   WR_U_ID 
    ,   WR_Qty  
    ,   WR_De   
FROM
        RT
WHERE 
        WR_Sts = '대기'


E_0004 = 특별보상이벤트

WR_ID       WR_E_ID     WR_RW_ID    WR_U_ID     WR_Qty   WR_Sts      WR_De       
WR_0001     E_0004      RW_0010     U_0001      22         대기      2024-01-30
WR_0002     E_0004      RW_0011     U_0001      22         대기      2024-01-30

운영자 또는 관리자가 검증을 해야한다면 대기 중인 상태로 있다가 
승인 완료시 WR_Sts가 변경되고 UQ테이블에 레코드가 기록됩니다

자동으로 지급하게 된다면, WR_Sts를 바로 승인으로 입력하고
추가 검증로직을 구현해야합니다.

-예상 결과-
WR_ID       WR_E_ID     WR_RW_ID    WR_U_ID     WR_Qty   WR_Sts      WR_De       
WR_0001     E_0004      RW_0010     U_0001      22         승인      2024-01-30
WR_0002     E_0004      RW_0011     U_0001      22         승인      2024-01-30







-UQ테이블의 예상결과-
UQ_ID      UQ_U_ID    UQ_E_ID   UQ_RW_ID     UQ_Qty     UQ_Sts    UQ_De    
UQ_0001    U_0001     E_0001    RW_0001         3        획득    2024-01-23
UQ_0002    U_0001     E_0003    RW_0001         -1       사용    2024-01-23
UQ_0003    U_0001     E_0003    RW_0001         -1       사용    2024-01-23
UQ_0004    U_0001     E_0004    RW_0010         3        획득    2024-01-30
UQ_0005    U_0001     E_0004    RW_0011         1        획득    2024-01-30


보상 요청 내역 확인은 
RT 테이블을 바라보면 됩니다.


또한 보상 이력 조회는 
UQ테이블을 바라보면 됩니다.



----------------
이벤트에 연결된 보상 추가


예시데이터

E_ID    	E_Nm    	    E_SrtDe 	E_EndDe 	E_Sts   	E_U_ID  	E_InDe  
E_0001	    퀴즈이벤트	    2025-05-13	2025-05-19	진행중	      U_0005	2025-05-13
E_0002	    룰렛이벤트	    2025-05-13	2025-05-19	진행중	      U_0005	2025-05-13
E_0003	    기타이벤트	    2025-08-08	2025-09-09	대기중	      U_0005	2025-05-13


RW_ID   	RW_E_ID 	RW_Nm   	RW_Qty  	RW_U_ID 	RW_De   
RW_0001	    E_0001	    룰렛티켓               3	        U_0005	2025-05-13
RW_0002	    E_0002	    하얀포션               100	        U_0005	2025-05-13
RW_0003	    E_0002	    빨간포션               50	        U_0005	2025-05-13
RW_0004	    E_0002	    파란포션               200	        U_0005	2025-05-13
RW_0005	    E_0002	    검	                   1	        U_0005	2025-05-13
RW_0006	    E_0002	    도끼	            1	        U_0005	2025-05-13
RW_0007	    E_0002	    전민10%	            1	        U_0005	2025-05-13
RW_0008	    E_0002	    전행10%	            1	        U_0005	2025-05-13
RW_0009	    E_0003	    전힘10%	            1	        U_0005	2025-05-13


룰렛은 보상은 랜덤으로 
룰렛티켓돌린값은은 고정


-----------------

역할구분
이벤트생성 : 운영자 , 관리자
보상 정의 : 운영자 , 관리자
보상 요청 처리 : 운영자 관리자 or 자동(검증필요)
보상 내역 확인 : 유저 , 운영자, 관리자, 감사자




보상 요청 : 운영자 관리자 유저
이력조회 : 유저는 자기 자신것만
운영자 관리자 감사자 : 모든 유저의 기록조회



-------------------------
순서
1. 회원가입(유저등록)
2. 로그인
3. 이벤트 등록
4. 보상 등록
5. 이벤트 실행
6. 보상 요청
7. 지급 상태 저장
8. 지급 내역 조회





-------------JWT토큰관리--------
도커와 포스트맨으로 이용중인데, HTTP요청을 할 때 마다 토큰을 내부 API가 자동으로 호출하고 자동 갱신,첨부하도록 만드는데 어려움이 컸음.
